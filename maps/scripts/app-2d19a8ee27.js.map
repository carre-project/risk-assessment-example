{"version":3,"sources":["scripts/app-2d19a8ee27.js"],"names":["angular","module","config","$locationProvider","html5Mode","controller","$scope","$location","API","$sce","$timeout","cfpLoadingBar","CONFIG","getMeasureListWithLatestValue","user","username","lastMeasurements","then","res","data","results","predicates","values","observable_names","ob_dates","map","obj","push","p","value","replace","makeLabel","ob","ob_name","date","getRiskEvidences","err","risk_evidences","summary","risk_factors","total_risk_evidences","length","forEach","rv","result","RiskEvidenceConditionParser","evaluate","condition","risk_factor","risk_evidence","rf_source","has_risk_factor_source","rf_target","has_risk_factor_target","rf_label","rl_source_name","has_risk_factor_association_type","rl_target_name","risk_elements","label","source","target","evidences","confidence_interval_min","confidence_interval_max","risk_evidence_ratio_value","display","loading","rf","link","ev","ratio","measurements","Date","toLocaleString","setGraphUrl","iframesLoaded","base","params","language","url","Object","keys","join","entrysystemUrlSankey","trustAsResourceUrl","str","indexOf","substring","lastIndexOf","CARRE_DEVICES","accounts","testToken","token","search","baseUrl","absUrl","loginUrl","logoutUrl","visualizationType","oauth_token","loadData","loadTestUser","start","lang","changeLanguage","iframeLoaded","complete","constant","service","$http","$cookies","$q","getUser","TOKEN","get","URL","email","r","defer","reject","promise","get_lastMeasurements","query","prefixes","post","encodeURIComponent","get_risk_evidences","this","exports"],"mappings":"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","file":"scripts/app-2d19a8ee27.js","sourcesContent":["/*global angular,RiskEvidenceConditionParser */\nangular.module('CarreExample', ['ngCookies','ngSanitize','ngAnimate','cfp.loadingBar','ngOnload'])\n  .config(function($locationProvider) {\n    $locationProvider.html5Mode(true);\n  })\n  .controller('ExampleController', function($scope, $location, API,$sce, $timeout,cfpLoadingBar,CONFIG) {\n\n    //set up the urls \n    var CARRE_DEVICES = API.accounts;\n    var testToken = '66efc31e652208e257c3781b2a40376084c0a2ac',token=null;\n    if($location.search().token) token = $location.search().token;\n    \n    //clean up the browser url\n    $location.url('/').replace();\n    var baseUrl = $location.absUrl();\n    $scope.loginUrl = CARRE_DEVICES + '/login?next=' + baseUrl;\n    $scope.logoutUrl = CARRE_DEVICES + '/logout?next=' + baseUrl;\n    \n    // set default visualization type\n    $scope.visualizationType = 'list';\n\n    // Retrieving a cookie and set initial user object\n    API.user(token).then(function(res) {\n      $scope.user = {\n        oauth_token: res.oauth_token,\n        username: res.username\n      };\n      $scope.loadData();\n    });\n\n    $scope.loadTestUser = function() { \n      API.user(testToken).then(function(res) {\n        $scope.user = {\n          oauth_token: res.oauth_token,\n          username: res.username\n        };\n        $scope.loadData();\n      });\n    };\n\n    $scope.loadData = function() {\n      $scope.measurements=[];\n      $scope.loading = true;\n      cfpLoadingBar.start();\n      getMeasureListWithLatestValue();\n    };\n\n    var results = {};\n    \n    function getMeasureListWithLatestValue() {\n\n      if (!$scope.user.username) return;\n      API.lastMeasurements($scope.user).then(function(res) {\n        console.log(res);\n        var data = res.data;\n\n        results.predicates = [];\n        results.values = {};\n        results.observable_names = {};\n        results.ob_dates = {};\n\n        data.map(function(obj) {\n          results.predicates.push(obj.p.value.replace(\"http://carre.kmi.open.ac.uk/ontology/sensors.owl#\", \":\"));\n          results.values[makeLabel(obj.ob.value)] = obj.value.value;\n          results.observable_names[makeLabel(obj.ob.value)] = obj.ob_name.value;\n          results.ob_dates[makeLabel(obj.ob.value)] = obj.date.value;\n        });\n\n        //get the risk evidences\n        getRiskEvidences();\n      }, function(err) { console.log(\"Error in query measurementList\"); console.log(err); });\n\n\n    }\n\n\n    function getRiskEvidences() {\n\n      API.risk_evidences($scope.user, results.predicates).then(function(res) {\n        var data = res.data;\n        results.summary = [];\n        results.risk_evidences = {};\n        results.risk_factors = {};\n        results.total_risk_evidences = data.length;\n        data.forEach(function(rv) {\n          var result = RiskEvidenceConditionParser.evaluate(rv.condition.value, results.values);\n\n          //             console.log(\n          //               makeLabel(rv.risk_factor.value),\n          //               makeLabel(rv.risk_evidence.value),\n          //               result,\n          //               rv.condition.value,getValues(results.values).join(\"|\"),\n          //               \"---------\"\n          //             );\n\n\n          if (result) {\n\n            var risk_factor = makeLabel(rv.risk_factor.value);\n            var risk_evidence = makeLabel(rv.risk_evidence.value);\n            var rf_source = makeLabel(rv.has_risk_factor_source.value);\n            var rf_target = makeLabel(rv.has_risk_factor_target.value);\n            var rf_label = makeLabel(rv.rl_source_name.value) + \" \" +\n              makeLabel(rv.has_risk_factor_association_type.value) + \" \" +\n              makeLabel(rv.rl_target_name.value);\n            \n            \n            results.risk_elements\n            \n            results.risk_factors[risk_factor] = results.risk_factors[risk_factor] || {\n              label: rf_label,\n              source:rf_source,\n              target:rf_target,\n              evidences: []\n            };\n\n            results.risk_factors[risk_factor].evidences.push(risk_evidence);\n            results.risk_evidences[risk_evidence] = {\n              confidence_interval_min: rv.confidence_interval_min.value,\n              confidence_interval_max: rv.confidence_interval_max.value,\n              risk_evidence_ratio_value: rv.risk_evidence_ratio_value.value\n            };\n\n          }\n\n        });\n        console.log(results);\n        display(results);\n        $scope.loading = false;\n        //           console.log(\n        //             results.risk_factors,\n        //             results.values,\n        //             results.summary.length+\"/\"+results.total_risk_evidences);\n\n      });\n\n    }\n\n    function display(results) {\n\n      $scope.risk_factors = [];\n      //make risk factors with evidences\n      for (var rf in results.risk_factors) {\n        $scope.risk_factors.push({\n          label: results.risk_factors[rf].label,\n          link: \"https://entry.carre-project.eu/risk_factors/\" + rf,\n          evidences: results.risk_factors[rf].evidences.map(function(ev) {\n            return {\n              link: \"https://entry.carre-project.eu/risk_evidences/\" + ev,\n              label: ev,\n              ratio: results.risk_evidences[ev].risk_evidence_ratio_value\n            };\n          })\n        });\n      }\n      $scope.measurements = [];\n      //make measurements\n      for (var ob in results.observable_names) {\n        $scope.measurements.push({\n          label: results.observable_names[ob],\n          link: \"https://entry.carre-project.eu/observables/\" + ob,\n          value: results.values[ob],\n          date: new Date(results.ob_dates[ob]).toLocaleString()\n        });\n      }\n      setGraphUrl();\n\n    }\n    \n    // Change language specific\n    $scope.lang=CONFIG.language;\n    $scope.changeLanguage = function(){\n      CONFIG.language = $scope.lang;\n      $scope.loadData();\n    }\n    \n    \n    $scope.iframeLoaded=function(){\n      $scope.iframesLoaded++;\n      if($scope.iframesLoaded===1) {\n        cfpLoadingBar.complete();\n      }\n    };\n    \n    function setGraphUrl(){\n      $scope.iframesLoaded=0;\n      \n      var base = \"//entry.carre-project.eu/\";\n      // var base = \"//beta.carre-project.eu:3000/#/\";\n      var params = \"explore?embed=true&hidemenu=true&showonlygraph=true&elementstype=risk_evidences&lang=\"+CONFIG.language;\n      var url = base+params+\"&elements=\"+Object.keys(results.risk_evidences).join(\",\");\n      $scope.entrysystemUrlSankey = $sce.trustAsResourceUrl(url+\"&graphtype=sankey\");\n      // $scope.entrysystemUrlNetwork = $sce.trustAsResourceUrl(url+\"&graphtype=network\");\n    }\n\n    function makeLabel(str) {\n      var result = \"\";\n      if (str.indexOf(\"#\") >= 0) {\n        result = str.substring(str.lastIndexOf(\"#\") + 1)\n          .replace(\"risk_factor_association_type\", \"\");\n      } else result = str.substring(str.lastIndexOf(\"/\") + 1);\n      if (result.indexOf(\"RF_\") +\n        result.indexOf(\"OB_\") +\n        result.indexOf(\"RV_\") +\n        result.indexOf(\"RL_\") > -4) return result;\n      else return result.replace(/[_-]+/g, \" \");\n    }\n    \n\n  });\n  \n/*global angular */\nangular.module('CarreExample')\n  .constant('CONFIG',{\n    'language':'el'\n  })\n  .service('API', function($http, $cookies, $q,CONFIG) {\n\n    //set up the urls \n    var CARRE_DEVICES = 'https://devices.carre-project.eu/devices/accounts';\n    var URL = 'https://devices.carre-project.eu/ws/'; \n    var prefixes = \"PREFIX xsd: <http://www.w3.org/2001/XMLSchema#> \\n\\\n            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> \\n\\\n            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> \\n\\\n            PREFIX : <http://carre.kmi.open.ac.uk/ontology/sensors.owl#> \\n\\\n            PREFIX risk: <http://carre.kmi.open.ac.uk/ontology/risk.owl#> \\n\\\n            PREFIX carreManufacturer: <http://carre.kmi.open.ac.uk/manufacturers/> \\n\\\n            PREFIX carreUsers: <https://carre.kmi.open.ac.uk/users/> \\n \";\n\n    \n  this.exports={\n    'accounts': CARRE_DEVICES,\n    'user': getUser,\n    'lastMeasurements': get_lastMeasurements,\n    'risk_evidences': get_risk_evidences\n  };\n  \n  function getUser(token){\n    var TOKEN = $cookies.get('CARRE_USER') || token || '';\n    //validate cookie token with userProfile api function and get username userGraph\n    if (TOKEN.length > 0) {\n      return $http.get(URL + 'userProfile?token=' + TOKEN).then(function(res) {\n        return {\n          oauth_token: TOKEN,\n          username: res.data.username,\n          email: res.data.email\n        };\n      }, function(err) {\n        console.log(err);\n        return {}\n      });\n    } else {\n      var r=$q.defer();\n      r.reject({})\n      return r.promise;\n    }\n  }\n  \n  \n  function get_lastMeasurements(user) {\n  \n    console.log(\"Get Measurement of List \");\n\n    var query = prefixes +\n    \"SELECT ?date ?p ?value ?ob ?ob_name FROM <https://carre.kmi.open.ac.uk/users/\"+user.username+\"> FROM <http://carre.kmi.open.ac.uk/riskdata> WHERE {  \\n\\\n    { \\n\\\n    SELECT max(?d) as ?date ?p FROM <https://carre.kmi.open.ac.uk/users/\"+user.username+\"> WHERE { \\n\\\n            ?m :has_date / :has_value ?d ; ?p ?o . \\n\\\n            ?o :has_value ?v1 . \\n\\\n                FILTER(!(?p = :has_date) && !(?p = :has_start_date)&& !(?p = :has_end_date) && !(?p = :has_sleep_status)) \\n\\\n        } } \\n\\\n    ?measurement :has_date / :has_value ?date ; ?p ?o . \\n\\\n    ?o :has_value ?value . ?ob a risk:observable ; risk:has_external_predicate ?p; risk:has_observable_name ?ob_name.  \\n\\\n    FILTER (lang(?ob_name)='\"+CONFIG.language+\"') \\n\\\n    } \\n\";\n\n    return $http.post(URL+'query?token='+user.oauth_token+'&sparql='+encodeURIComponent(query));\n    \n\n  }\n  \n\n  \n  function get_risk_evidences(user,predicates) {\n\n    console.log(\"Get RiskEvidences of List \");\n    var query = prefixes+\"SELECT DISTINCT ?risk_evidence ?condition ?confidence_interval_min ?confidence_interval_max ?risk_evidence_ratio_value ?risk_evidence_ratio_type ?risk_factor ?has_risk_factor_source ?has_risk_factor_target ?rl_source_name ?rl_target_name ?has_risk_factor_association_type FROM <http://carre.kmi.open.ac.uk/riskdata> WHERE {  \\n \"+\n    \"  ?risk_evidence a risk:risk_evidence ;  \\n \"+\n    \"  risk:has_risk_factor ?risk_factor;  \\n \"+\n    \" risk:has_risk_evidence_ratio_type ?risk_evidence_ratio_type;  \\n \"+\n    \"   risk:has_risk_evidence_ratio_value ?risk_evidence_ratio_value;  \\n \"+\n    \"   risk:has_confidence_interval_max ?confidence_interval_max;  \\n \"+\n    \"   risk:has_confidence_interval_min ?confidence_interval_min;  \\n \"+\n    \"   risk:has_risk_evidence_observable ?ob ;  \\n \"+\n    \"   risk:has_observable_condition ?condition .  \\n \"+\n    \" #details for risk factor  \\n \"+\n    \" ?risk_factor risk:has_risk_factor_association_type ?has_risk_factor_association_type;  \\n \"+\n    \" risk:has_risk_factor_source ?has_risk_factor_source;  \\n \"+\n    \" risk:has_risk_factor_target ?has_risk_factor_target.  \\n \"+\n    \" ?has_risk_factor_source risk:has_risk_element_name ?rl_source_name.  \\n \"+\n    \" ?has_risk_factor_target risk:has_risk_element_name ?rl_target_name.   \\n \"+\n    \" FILTER(lang(?rl_source_name)='\"+CONFIG.language+\"')   \\n \"+\n    \" FILTER(lang(?rl_target_name)='\"+CONFIG.language+\"')   \\n \"+\n    \" {  \\n \"+\n    \"  SELECT ?ob FROM <http://carre.kmi.open.ac.uk/riskdata> WHERE {  \\n \"+\n    \"  ?ob a risk:observable ;  \\n \"+\n    \"         risk:has_external_predicate ?p.    \\n \"+\n    \" VALUES ?p {  \\n \"+predicates.join(\" \")+\" }  \\n \"+\n    \" }  \\n \"+\n    \" }  \\n \"+\n    \" }\";\n\n\n    return $http.post(URL+'query?token='+user.oauth_token+'&sparql='+encodeURIComponent(query));\n    \n\n  }\n  \n\n\n  \n  return this.exports;\n  \n});"],"sourceRoot":"/source/"}